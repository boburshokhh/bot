# Вариант деплоя: приложение на этом сервере, PostgreSQL и Redis — на основном.
# Заполните в .env: DATABASE_URL, REDIS_URL (на IP основного сервера), TELEGRAM_BOT_TOKEN, WEBHOOK_BASE_URL.
# Запуск: docker compose -f docker-compose.yml -f docker-compose.remote.yml up -d --build

services:
  app:
    build: .
    ports:
      - "8000:8000"
    environment:
      DATABASE_URL: ${DATABASE_URL}
      REDIS_URL: ${REDIS_URL}
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN}
      WEBHOOK_SECRET: ${WEBHOOK_SECRET:-}
      WEBHOOK_BASE_URL: ${WEBHOOK_BASE_URL:-}
    restart: unless-stopped

  celery_worker:
    build: .
    command: celery -A src.scheduler.celery_app worker --loglevel=info
    environment:
      DATABASE_URL: ${DATABASE_URL}
      REDIS_URL: ${REDIS_URL}
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN}
    depends_on:
      - app
    restart: unless-stopped

  celery_beat:
    build: .
    command: celery -A src.scheduler.celery_app beat --loglevel=info
    environment:
      DATABASE_URL: ${DATABASE_URL}
      REDIS_URL: ${REDIS_URL}
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN}
    depends_on:
      - celery_worker
    restart: unless-stopped
