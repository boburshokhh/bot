<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Planning Bot WebApp</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <script src="/static/webapp.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #667eea;
      --primary-dark: #5568d3;
      --secondary: #764ba2;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --bg: #f8fafc;
      --card-bg: #ffffff;
      --text: #1f2937;
      --text-muted: #6b7280;
      --border: #e5e7eb;
      --shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.1);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      padding: 16px;
      line-height: 1.6;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
    }

    .card {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: var(--shadow);
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .card:hover {
      box-shadow: var(--shadow-lg);
    }

    .card-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
      font-size: 18px;
      font-weight: 600;
      color: var(--text);
    }

    .card-header-icon {
      font-size: 24px;
    }

    .btn {
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: white;
      border: none;
      border-radius: 12px;
      padding: 12px 24px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      width: 100%;
      margin-top: 12px;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(102, 126, 234, 0.3);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn-secondary {
      background: var(--text-muted);
    }

    .btn-success {
      background: var(--success);
    }

    .btn-danger {
      background: var(--danger);
    }

    .btn-small {
      padding: 8px 16px;
      font-size: 13px;
      width: auto;
      margin: 0 4px;
    }

    .input-group {
      margin-bottom: 16px;
    }

    .input-group label {
      display: block;
      margin-bottom: 6px;
      font-size: 14px;
      font-weight: 500;
      color: var(--text);
    }

    input, select, textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid var(--border);
      border-radius: 10px;
      font-size: 15px;
      transition: border-color 0.2s;
      font-family: inherit;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary);
    }

    textarea {
      min-height: 100px;
      resize: vertical;
    }

    .task-card {
      background: #f9fafb;
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      margin-top: 12px;
      transition: all 0.2s;
    }

    .task-card:hover {
      border-color: var(--primary);
      background: #f3f4f6;
    }

    .task-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .task-number {
      font-weight: 600;
      color: var(--primary);
      margin-right: 8px;
    }

    .task-text {
      flex: 1;
      font-size: 15px;
      line-height: 1.5;
    }

    .task-status {
      font-size: 13px;
      padding: 4px 10px;
      border-radius: 8px;
      background: var(--border);
      color: var(--text-muted);
    }

    .task-status.done {
      background: #d1fae5;
      color: #065f46;
    }

    .task-status.partial {
      background: #fef3c7;
      color: #92400e;
    }

    .task-status.failed {
      background: #fee2e2;
      color: #991b1b;
    }

    .task-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      flex-wrap: wrap;
    }

    .task-comment {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border);
      font-size: 13px;
      color: var(--text-muted);
      font-style: italic;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
      margin-top: 12px;
    }

    .stat-item {
      text-align: center;
      padding: 16px;
      background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
      border-radius: 12px;
    }

    .stat-value {
      font-size: 24px;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 4px;
    }

    .stat-label {
      font-size: 12px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .status-bar {
      position: fixed;
      bottom: 16px;
      left: 16px;
      right: 16px;
      max-width: 600px;
      margin: 0 auto;
      padding: 12px 16px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 500;
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.3s;
      pointer-events: none;
      z-index: 1000;
    }

    .status-bar.show {
      opacity: 1;
      transform: translateY(0);
    }

    .status-bar.success {
      background: #d1fae5;
      color: #065f46;
    }

    .status-bar.error {
      background: #fee2e2;
      color: #991b1b;
    }

    .loading {
      text-align: center;
      padding: 20px;
      color: var(--text-muted);
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-muted);
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 12px;
    }

    .row {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }

    .history-item {
      padding: 12px;
      background: #f9fafb;
      border-radius: 10px;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .history-date {
      font-weight: 500;
    }

    .history-stats {
      font-size: 14px;
      color: var(--text-muted);
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: var(--border);
      border-radius: 4px;
      overflow: hidden;
      margin-top: 8px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary) 0%, var(--secondary) 100%);
      transition: width 0.3s;
    }
  </style>
</head>
<body>
  <div class="container" x-data="webapp()" x-init="init()">
    <!-- Today's Plan -->
    <div class="card">
      <div class="card-header">
        <span class="card-header-icon">üìã</span>
        <span>–°–µ–≥–æ–¥–Ω—è</span>
      </div>
      <div id="todayBlock">
        <div class="loading" x-show="loading.today">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        <div class="empty-state" x-show="!loading.today && (!today.tasks || today.tasks.length === 0)">
          <div class="empty-state-icon">üìù</div>
          <div>–ù–∞ —Å–µ–≥–æ–¥–Ω—è –ø–ª–∞–Ω–∞ –Ω–µ—Ç</div>
        </div>
        <template x-for="task in today.tasks" :key="task.id">
          <div class="task-card">
            <div class="task-header">
              <div class="task-text">
                <span class="task-number" x-text="task.position + 1 + '.'"></span>
                <span x-text="task.text"></span>
              </div>
            </div>
            <div class="task-status" 
                 :class="{
                   'done': task.status === 'done',
                   'partial': task.status === 'partial',
                   'failed': task.status === 'failed'
                 }"
                 x-text="getStatusLabel(task.status)"></div>
            <div class="task-actions">
              <button class="btn btn-success btn-small" @click="updateTaskStatus(task.id, 'done')">‚úÖ</button>
              <button class="btn btn-secondary btn-small" @click="updateTaskStatus(task.id, 'partial')">‚ö†Ô∏è</button>
              <button class="btn btn-danger btn-small" @click="updateTaskStatus(task.id, 'failed')">‚ùå</button>
            </div>
            <div class="row" style="margin-top: 12px;">
              <input type="text" 
                     :id="'comment-' + task.id" 
                     :placeholder="'–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –∑–∞–¥–∞—á–µ ' + (task.position + 1)"
                     style="flex: 1;" />
              <button class="btn btn-secondary btn-small" @click="saveComment(task.id)">üí¨ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
            <div class="task-comment" x-show="task.comment" x-text="'üí¨ ' + task.comment"></div>
          </div>
        </template>
      </div>
    </div>

    <!-- Create Plan -->
    <div class="card">
      <div class="card-header">
        <span class="card-header-icon">‚úèÔ∏è</span>
        <span>–°–æ–∑–¥–∞—Ç—å –ø–ª–∞–Ω –Ω–∞ —Å–µ–≥–æ–¥–Ω—è</span>
      </div>
      <textarea 
        id="planTasks" 
        placeholder="–ö–∞–∂–¥–∞—è –∑–∞–¥–∞—á–∞ —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏&#10;–ù–∞–ø—Ä–∏–º–µ—Ä:&#10;1. –ü—Ä–æ—á–∏—Ç–∞—Ç—å –æ—Ç—á—ë—Ç&#10;2. –í—Å—Ç—Ä–µ—á–∞ –≤ 11:00&#10;3. –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞"
        x-model="newPlanText"></textarea>
      <button class="btn" @click="savePlan()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–ª–∞–Ω</button>
    </div>

    <!-- Settings -->
    <div class="card">
      <div class="card-header">
        <span class="card-header-icon">‚öôÔ∏è</span>
        <span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
      </div>
      <div class="input-group">
        <label>–ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å</label>
        <input type="text" id="tzInput" x-model="settings.timezone" placeholder="Europe/Moscow" />
      </div>
      <div class="row">
        <div class="input-group" style="flex: 1;">
          <label>–£—Ç—Ä–æ (HH:MM)</label>
          <input type="text" id="morningInput" x-model="settings.morning_time" placeholder="07:00" />
        </div>
        <div class="input-group" style="flex: 1;">
          <label>–í–µ—á–µ—Ä (HH:MM)</label>
          <input type="text" id="eveningInput" x-model="settings.evening_time" placeholder="21:00" />
        </div>
      </div>
      <div class="row">
        <div class="input-group" style="flex: 1;">
          <label>–ò–Ω—Ç–µ—Ä–≤–∞–ª –ø–æ–≤—Ç–æ—Ä–æ–≤ (–º–∏–Ω)</label>
          <input type="number" id="intervalInput" x-model="settings.reminder_interval_minutes" min="5" max="720" />
        </div>
        <div class="input-group" style="flex: 1;">
          <label>–ú–∞–∫—Å. –ø–æ–≤—Ç–æ—Ä–æ–≤</label>
          <input type="number" id="attemptsInput" x-model="settings.reminder_max_attempts" min="0" max="10" />
        </div>
      </div>
      <button class="btn" @click="saveSettings()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
    </div>

    <!-- Statistics -->
    <div class="card">
      <div class="card-header">
        <span class="card-header-icon">üìä</span>
        <span>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</span>
      </div>
      <div id="statsBlock">
        <div class="loading" x-show="loading.stats">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        <div class="stats-grid" x-show="!loading.stats">
          <div class="stat-item">
            <div class="stat-value" x-text="stats.total_plans || 0"></div>
            <div class="stat-label">–í—Å–µ–≥–æ –ø–ª–∞–Ω–æ–≤</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" x-text="(stats.avg_percent || 0) + '%'"></div>
            <div class="stat-label">–°—Ä–µ–¥–Ω–∏–π %</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" x-text="stats.current_streak || 0"></div>
            <div class="stat-label">–¢–µ–∫—É—â–∏–π —Å—Ç—Ä–∏–∫</div>
          </div>
        </div>
      </div>
    </div>

    <!-- History -->
    <div class="card">
      <div class="card-header">
        <span class="card-header-icon">üìÖ</span>
        <span>–ò—Å—Ç–æ—Ä–∏—è</span>
      </div>
      <div class="row">
        <input type="month" id="historyMonthInput" x-model="historyMonth" style="flex: 1;" />
        <button class="btn btn-secondary btn-small" @click="loadHistory()">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
      </div>
      <div id="historyBlock" style="margin-top: 16px;">
        <div class="loading" x-show="loading.history">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        <div class="empty-state" x-show="!loading.history && (!history.items || history.items.length === 0)">
          <div class="empty-state-icon">üì≠</div>
          <div>–ó–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –º–µ—Å—è—Ü –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç</div>
        </div>
        <template x-for="item in history.items" :key="item.date">
          <div class="history-item">
            <div>
              <div class="history-date" x-text="formatDate(item.date)"></div>
              <div class="history-stats" x-text="item.done + '/' + item.total + ' (' + item.percent + '%)'"></div>
              <div class="progress-bar">
                <div class="progress-fill" :style="'width: ' + item.percent + '%'"></div>
              </div>
            </div>
          </div>
        </template>
      </div>
    </div>

    <!-- Status Bar -->
    <div class="status-bar" 
         :class="{ 'show': status.show, 'success': status.type === 'success', 'error': status.type === 'error' }"
         x-text="status.message"></div>
  </div>
</body>
</html>
