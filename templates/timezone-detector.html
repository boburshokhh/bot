<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .container {
      background: white;
      border-radius: 20px;
      padding: 32px;
      max-width: 400px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      text-align: center;
    }
    h1 {
      font-size: 24px;
      color: #1f2937;
      margin-bottom: 16px;
    }
    .timezone-display {
      background: #f3f4f6;
      border-radius: 12px;
      padding: 20px;
      margin: 24px 0;
      font-size: 18px;
      font-weight: 600;
      color: #667eea;
    }
    .time-display {
      font-size: 14px;
      color: #6b7280;
      margin-top: 8px;
    }
    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 12px;
      padding: 14px 28px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      transition: transform 0.2s, box-shadow 0.2s;
      margin-top: 16px;
    }
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
    }
    button:active {
      transform: translateY(0);
    }
    .loading {
      display: none;
      color: #6b7280;
      margin-top: 16px;
    }
    .loading.active {
      display: block;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üåç –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞</h1>
    <div class="timezone-display" id="timezoneDisplay">
      –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ...
    </div>
    <div class="time-display" id="timeDisplay"></div>
    <button id="saveBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å</button>
    <div class="loading" id="loading">–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...</div>
  </div>

  <script>
    (function() {
      const tg = window.Telegram?.WebApp;
      if (tg) {
        tg.ready();
        tg.expand();
      }

      const timezoneDisplay = document.getElementById('timezoneDisplay');
      const timeDisplay = document.getElementById('timeDisplay');
      const saveBtn = document.getElementById('saveBtn');
      const loading = document.getElementById('loading');

      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å –±—Ä–∞—É–∑–µ—Ä–∞
      const detectedTz = Intl.DateTimeFormat().resolvedOptions().timeZone;
      timezoneDisplay.textContent = detectedTz;

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è
      function updateTime() {
        const now = new Date();
        const timeStr = now.toLocaleString('ru-RU', {
          timeZone: detectedTz,
          year: 'numeric',
          month: 'long',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit',
          timeZoneName: 'short'
        });
        timeDisplay.textContent = `–¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è: ${timeStr}`;
      }
      updateTime();
      setInterval(updateTime, 1000);

      // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞
      saveBtn.addEventListener('click', async () => {
        saveBtn.disabled = true;
        loading.classList.add('active');

        try {
          const initData = tg?.initData || '';
          const response = await fetch('/api/timezone/detect', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-Telegram-Init-Data': initData,
            },
            body: JSON.stringify({ timezone: detectedTz }),
          });

          if (!response.ok) {
            throw new Error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
          }

          // –ó–∞–∫—Ä—ã–≤–∞–µ–º WebApp –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç—É
          if (tg) {
            tg.sendData(JSON.stringify({ timezone: detectedTz }));
            tg.close();
          } else {
            alert('–ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å —Å–æ—Ö—Ä–∞–Ω—ë–Ω!');
            window.close();
          }
        } catch (error) {
          alert('–û—à–∏–±–∫–∞: ' + error.message);
          saveBtn.disabled = false;
          loading.classList.remove('active');
        }
      });
    })();
  </script>
</body>
</html>
